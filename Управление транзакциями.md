_Транзакция_ -- последовательность операций с БД, которые составляют логическую единицу работы. 

Транзация должна удовлетворять следующим требованиям (ACID) [[Литература#^af0aa6]]<c. 458>:
- Атомарность -- либо все операции, которые входят в транзакцию, выполняются успешно, либо не выполняется ни одна из них,
- Целостность / Согласованность / Консистентность (consistency) -- транзакция должно переводить базу данных из одного целостного состояния в другое целостное состояние.
- Изолированность -- транзакция должна выполняться без взаимодействия с другими транзакциями. Параллельно выполняемые транзакции не должны оказывать влияния друг на друга.
- Долговечность / Постоянство (durability) -- после успешного завершения транзакции все внесенные ею изменения должны быть сохранены.

Чем выше уровень блокировки, тем ниже производительность. Параллельным транзакциям приходится ждать, пока транзакция, которая началась раньше, освободит данные. Блокировка данных обеспечивается средствами СУБД, но пользователь может установить _уровень изолированности транзакций_.
### Команды управления транзакциями

Транзакция начинается с выполнения первого SQL-оператора и заканчивается при наступлении следующих событий:
- При выполнении команд `COMMIT` или `ROLLBACK`.
- При нормальном завершении блока, при этом автоматически фиксируются все изменения, осуществленные в этой транзакции.
- При возникновении ошибок сервера и аварийном завершении сеанса пользователя, при этом отменяются все изменения, осуществленные в последней транзакции.

В PostgreSQL транзакция начинается командой `BEGIN;` и завершается командой `COMMIT;`. В блоках PL/pgSQL (анонимных, процедурах, функциях, триггерах) транзакция начинается неявно, в начале блока, и может завершиться неявно, при завершении работы блока, либо завершается явно командами `COMMIT` или `ROLLBACK`.

Для управления транзакциями в PostgreSQL используются следующие команды:
- `COMMIT`: фиксирует все изменения, осуществленные в текущей транзакции,
- `SAVEPOINT`: устанавливает точку сохранения внутри транзакции; это позволяет отменить изменения, которые будут выполнены после точки сохранения, и сохранить изменения, которые были выполнены до точки сохранения; точки сохранения могут быть установлены только внутри блока транзакции; в транзакции может быть определено несколько точек сохранения.
- `ROLLBACK TO SAVEPOINT`: отменяет все изменения, осуществленные после определенной точки сохранения,
- `ROLLBACK`: отменяет все изменения, которые были внесены в базу данных в текущей транзакции, и работа блока PL/pgSQL, который содержит эту транзакцию, завершается.

NB! Команды `SAVEPOINT` и `ROLLBACK TO SAVEPOINT` нельзя использовать в блоках PL/pgSQL: анонимных блоках, процедурах, функциях, триггерах.

Пример. Увеличение зарплаты сотрудника с использованием команд `COMMIT` и `ROLLBACK`, для реализации рассматриваемого ограничения
```sql
DO $$
DECLARE
  v_emp_id INTEGER := 107;
  v_add NUMERIC(8, 2) := 2000;
  v_job VARCHAR(10);
  v_sal NUMERIC(8, 2);
  v_max_sal NUMERIC(8, 2);
BEGIN
  SELECT job_id, salary INTO v_job, v_sal
  FROM employees
  WHERE employee_id = v_emp_id;
  --
  SELECT max_salary INTO v_max_sal
  FROM jobs
  WHERE job_id = v_job;
  --
  UPDATE employees
  SET salary = salary + v_add
  WHERE employee_id = v_emp_id;
  --
  SELECT salary INTO v_sal
  FROM employees
  WHERE employee_id = v_emp_id;
  --
  IF v_sal > v_max_sal THEN
    ROLLBACK; -- откатываем всю транзакцию
	RAISE NOTICE 'Увеличение зарплаты отменено.';
  ELSE COMMIT; -- или фиксируем изменения
  END IF;
  --
  SELECT salary INTO v_sal
  FROM employees 
  WHERE employee_id = v_emp_id;
END $$;
```

Если итерация завершилась командой `COMMIT`, то изменения фиксируются. Если итерация завершилась командой `ROLLBACK`, то изменения, произошедшие на этой итерации, отменяются, и осуществляется переход к следующей итерации [[Литература#^af0aa6]]<c. 469>.

